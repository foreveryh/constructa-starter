# æ··åˆå¼€å‘ç¯å¢ƒï¼šDocker åŸºç¡€è®¾æ–½ + æœ¬åœ°åº”ç”¨

## è®¾è®¡ç†å¿µ

å°†å¼€å‘ç¯å¢ƒåˆ†ä¸ºä¸¤å±‚ï¼š
- **åŸºç¡€è®¾æ–½å±‚**ï¼šè¿è¡Œåœ¨ Docker ä¸­ï¼Œæä¾›æ•°æ®åº“ã€ç¼“å­˜ã€å­˜å‚¨ç­‰æœåŠ¡
- **åº”ç”¨å±‚**ï¼šè¿è¡Œåœ¨æœ¬åœ° Node.jsï¼Œæä¾›çƒ­æ›´æ–°ã€å¿«é€Ÿé‡å¯ã€æ–¹ä¾¿è°ƒè¯•

è¿™ç§æ¨¡å¼ç»“åˆäº† Docker çš„ç¯å¢ƒä¸€è‡´æ€§å’Œæœ¬åœ°å¼€å‘çš„çµæ´»æ€§ã€‚

---

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°å¼€å‘æœºå™¨                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åº”ç”¨å±‚ï¼ˆæœ¬åœ° Node.jsï¼‰                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  pnpm dev (å‰ç«¯åº”ç”¨)            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Vite çƒ­æ›´æ–° (HMR)            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - å¿«é€Ÿé‡å¯ (1-2ç§’)             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - æºç è°ƒè¯• (æ–­ç‚¹ã€console)      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  node ws-server.mjs (WebSocket) â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ ç½‘ç»œè¿æ¥ï¼ˆlocalhost:ç«¯å£ï¼‰
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Composeï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL (pgvector)              â”‚  â”‚
â”‚  â”‚  - ç«¯å£ 5432                        â”‚  â”‚
â”‚  â”‚  - æ•°æ®æŒä¹…åŒ–åˆ° Docker volume        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Redis                              â”‚  â”‚
â”‚  â”‚  - ç«¯å£ 6379                        â”‚  â”‚
â”‚  â”‚  - ç”¨äºç¼“å­˜ã€é˜Ÿåˆ—ï¼ˆBullMQï¼‰          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MinIO                              â”‚  â”‚
â”‚  â”‚  - ç«¯å£ 9000 (API), 9001 (Console)   â”‚  â”‚
â”‚  â”‚  - S3 å…¼å®¹å¯¹è±¡å­˜å‚¨                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Meilisearch                        â”‚  â”‚
â”‚  â”‚  - ç«¯å£ 7700                        â”‚  â”‚
â”‚  â”‚  - å…¨æ–‡æœç´¢å¼•æ“                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¼˜åŠ¿

### å¯¹æ¯”çº¯æœ¬åœ°å¼€å‘
| ç‰¹æ€§ | çº¯æœ¬åœ° | æ··åˆæ¨¡å¼ |
|------|--------|----------|
| ç¯å¢ƒæ­å»º | éœ€è¦å®‰è£…æ‰€æœ‰ä¾èµ– | åªéœ€ Docker |
| ç¯å¢ƒä¸€è‡´æ€§ | æ¯ä¸ªäººæœºå™¨ä¸åŒ | Docker ä¿è¯ä¸€è‡´ |
| æ•°æ®å…±äº« | éœ€è¦é¢å¤–çš„æ•°æ®åŒæ­¥ | å…±äº« Docker volumes |
| ä¾èµ–ç‰ˆæœ¬ | å¯èƒ½ä¸ä¸€è‡´ | Docker é”å®šç‰ˆæœ¬ |

### å¯¹æ¯”çº¯ Docker å¼€å‘
| ç‰¹æ€§ | çº¯ Docker | æ··åˆæ¨¡å¼ |
|------|-----------|----------|
| çƒ­æ›´æ–° | éœ€è¦é‡æ–°æ„å»ºå®¹å™¨ | Vite HMR å³æ—¶ç”Ÿæ•ˆ |
| é‡å¯é€Ÿåº¦ | 10-30 ç§’ | 1-2 ç§’ |
| æºç è°ƒè¯• | éœ€è¦æŒ‚è½½ volume æˆ– attach | ç›´æ¥æœ¬åœ°è°ƒè¯• |
| èµ„æºå ç”¨ | å…¨åœ¨å®¹å™¨ä¸­ | åº”ç”¨åœ¨æœ¬åœ°ï¼Œæ›´è½»é‡ |

### å¯¹æ¯”ç”Ÿäº§ Docker éƒ¨ç½²
| ç‰¹æ€§ | å¼€å‘æ··åˆæ¨¡å¼ | ç”Ÿäº§ Docker |
|------|--------------|-----------|
| åº”ç”¨è¿è¡Œ | æœ¬åœ° Node.js | Docker å®¹å™¨ |
| è®¿é—®åœ°å€ | http://localhost:3000 | http://localhost:5050 |
| é…ç½®æ–‡ä»¶ | .envï¼ˆæœ¬åœ°å¼€å‘ï¼‰ | .env + .env.docker |
| å¯åŠ¨æ–¹å¼ | pnpm ex0 init + pnpm dev | docker compose --profile selfhost up -d |

---

## å®ç°æ­¥éª¤

### 1. åˆ›å»º CLI å·¥å…·ï¼ˆ`cli/index.ts`ï¼‰

```typescript
#!/usr/bin/env node
import { defineCommand, runMain } from 'citty'
import { execSync } from 'node:child_process'

const runCommand = (command: string, description: string) => {
  console.log(`\nğŸš€ ${description}...`)
  try {
    execSync(command, { stdio: 'inherit' })
    console.log(`âœ… ${description} å®Œæˆ`)
  } catch (error) {
    console.error(`âŒ ${description} å¤±è´¥`)
    process.exit(1)
  }
}

const initCommand = defineCommand({
  meta: { name: 'init', description: 'åˆå§‹åŒ–å¼€å‘ç¯å¢ƒï¼ˆå¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡ï¼‰' },
  async run() {
    // æ£€æŸ¥ Docker
    runCommand('docker --version', 'æ£€æŸ¥ Docker')
    runCommand('docker info', 'æ£€æŸ¥ Docker è¿è¡ŒçŠ¶æ€')

    // å¯åŠ¨åŸºç¡€è®¾æ–½
    runCommand(
      'docker compose up -d db minio provision-minio redis meilisearch',
      'å¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆæ•°æ®åº“ã€å­˜å‚¨ã€ç¼“å­˜ã€æœç´¢ï¼‰'
    )

    // è¿è¡Œè¿ç§»
    runCommand('npx drizzle-kit migrate', 'è¿è¡Œæ•°æ®åº“è¿ç§»')

    console.log('\nğŸ‰ å¼€å‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼')
    console.log('ğŸ“ ä¸‹ä¸€æ­¥ï¼šè¿è¡Œ pnpm dev å¯åŠ¨åº”ç”¨')
  }
})

const stopCommand = defineCommand({
  meta: { name: 'stop', description: 'åœæ­¢æ‰€æœ‰ Docker æœåŠ¡' },
  async run() {
    runCommand('docker compose down', 'åœæ­¢ Docker æœåŠ¡')
  }
})

const reloadCommand = defineCommand({
  meta: { name: 'reload', description: 'é‡å¯åŸºç¡€è®¾æ–½æœåŠ¡' },
  async run() {
    runCommand('docker compose down', 'åœæ­¢æœåŠ¡')
    runCommand(
      'docker compose up -d db minio provision-minio redis meilisearch',
      'å¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡'
    )
  }
})

const main = defineCommand({
  meta: { name: 'dev-cli', version: '1.0.0', description: 'å¼€å‘ç¯å¢ƒç®¡ç† CLI' },
  subCommands: {
    init: initCommand,
    stop: stopCommand,
    reload: reloadCommand,
  }
})

runMain(main)
```

### 2. é…ç½® package.json

```json
{
  "scripts": {
    "dev": "vite dev",
    "ex0": "node cli/index.ts"
  }
}
```

### 3. é…ç½® docker-compose.yml

```yaml
services:
  # åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
  db:
    image: pgvector/pgvector:0.8.0-pg17
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - dev-data:/var/lib/postgresql/data
    ports:
      - '5432:5432'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U $${POSTGRES_USER}']
      interval: 5s
      timeout: 3s
      retries: 20

  # ... å…¶ä»–åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆredis, minio, meilisearchï¼‰

volumes:
  dev-data:
```

### 4. é…ç½® .env æ–‡ä»¶

```bash
# æœ¬åœ°å¼€å‘é…ç½®
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/devdb"
REDIS_URL="redis://localhost:6379"
S3_ENDPOINT="http://localhost:9000"
MEILI_HOST="http://localhost:7700"
```

---

## ä½¿ç”¨æŒ‡å—

### é¦–æ¬¡è®¾ç½®

```bash
# 1. å®‰è£…ä¾èµ–
pnpm install

# 2. åˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
pnpm ex0 init

# 3. å¯åŠ¨åº”ç”¨
pnpm dev
```

### æ—¥å¸¸å¼€å‘

```bash
# åªéœ€å¯åŠ¨åº”ç”¨ï¼ˆåŸºç¡€è®¾æ–½å·²è¿è¡Œï¼‰
pnpm dev
```

### é‡ç½®åŸºç¡€è®¾æ–½

```bash
# é‡å¯æ‰€æœ‰åŸºç¡€è®¾æ–½æœåŠ¡
pnpm ex0 reload

# æˆ–è€…å®Œå…¨åœæ­¢
pnpm ex0 stop
# ç„¶åé‡æ–°åˆå§‹åŒ–
pnpm ex0 init
```

---

## é…ç½®æ–‡ä»¶åˆ†ç¦»

### .envï¼ˆæœ¬åœ°å¼€å‘ï¼‰
```bash
# ä½¿ç”¨ localhost è¿æ¥ Docker ä¸­çš„æœåŠ¡
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/devdb"
S3_ENDPOINT="http://localhost:9000"
```

### .env.dockerï¼ˆDocker éƒ¨ç½²ï¼‰
```bash
# ä½¿ç”¨ Docker å®¹å™¨åè¿æ¥
DATABASE_URL="postgresql://postgres:postgres@db:5432/proddb"
S3_ENDPOINT="http://minio:9000"
```

---

## ç”Ÿäº§éƒ¨ç½²

å½“éœ€è¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼š

```bash
# ä½¿ç”¨ Docker å®Œæ•´éƒ¨ç½²
docker compose --env-file .env --env-file .env.docker --profile selfhost up -d --build
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šåº”ç”¨æ— æ³•è¿æ¥æ•°æ®åº“

```bash
# æ£€æŸ¥åŸºç¡€è®¾æ–½æ˜¯å¦è¿è¡Œ
docker compose ps

# æ£€æŸ¥æ•°æ®åº“æ—¥å¿—
docker compose logs db

# é‡å¯åŸºç¡€è®¾æ–½
pnpm ex0 reload
```

### é—®é¢˜ï¼šç«¯å£è¢«å ç”¨

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :3000
lsof -i :5432

# åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
kill -9 <PID>
```

### é—®é¢˜ï¼šDocker å†…å­˜ä¸è¶³

```bash
# å¢åŠ  Docker å†…å­˜é™åˆ¶
# Docker Desktop â†’ Settings â†’ Resources â†’ Memory: 8GB+
```

---

## æœ€ä½³å®è·µ

1. **ç‰ˆæœ¬æ§åˆ¶**
   - âœ… .env.example æäº¤åˆ° git
   - âŒ .env ä¸æäº¤ï¼ˆåŒ…å«æœ¬åœ°é…ç½®ï¼‰
   - âŒ .env.docker ä¸æäº¤ï¼ˆåŒ…å«ç”Ÿäº§é…ç½®ï¼‰

2. **æ•°æ®æŒä¹…åŒ–**
   - ä½¿ç”¨ Docker volumes ä¿å­˜æ•°æ®åº“
   - å®šæœŸå¤‡ä»½ï¼š`docker compose exec db pg_dump ...`

3. **ç¯å¢ƒéš”ç¦»**
   - å¼€å‘ï¼šlocalhost + æœ¬åœ° Node.js
   - ç”Ÿäº§ï¼šå®¹å™¨å + Docker å®¹å™¨

4. **å›¢é˜Ÿåä½œ**
   - æ–°æˆå‘˜åªéœ€ï¼š`git clone` â†’ `pnpm ex0 init` â†’ `pnpm dev`
   - ç¯å¢ƒè‡ªåŠ¨ä¸€è‡´ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®

---

## æ‰©å±•é˜…è¯»

- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Vite å¼€å‘æœåŠ¡å™¨](https://vitejs.dev/)
- [æ··åˆå¼€å‘æ¨¡å¼æœ€ä½³å®è·µ](https://www.docker.com/blog/containers-and-local-development/)
